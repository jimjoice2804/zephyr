[nix]
overlays = ["./.nixpacks/overlay.nix"]

[phases.setup]
nixPkgs = ["...", "nodejs_22", "prisma"]

[phases.install]
cmds = [
  "pnpm config set enable-pre-post-scripts true",
  "pnpm install --frozen-lockfile --ignore-scripts"
]

[phases.build]
cmds = [
  "cd packages/db && pnpm dlx prisma generate",
  "cd apps/web && NEXT_TELEMETRY_DISABLED=1 TURBO_TELEMETRY_DISABLED=1 pnpm run build"
]

[start]
cmd = "if [ -f apps/web/.next/standalone/server.js ]; then cd apps/web/.next/standalone && node server.js; elif [ -f apps/web/.next/standalone/server.mjs ]; then cd apps/web/.next/standalone && node server.mjs; else cd apps/web && pnpm start; fi"

[deploy]
healthcheckPath = "/"
healthcheckTimeout = 100
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[environment]
NEXT_TELEMETRY_DISABLED = "1"
TURBO_TELEMETRY_DISABLED = "1"
NODE_ENV = "production"
PNPM_HOME = "/tmp/.pnpm"
